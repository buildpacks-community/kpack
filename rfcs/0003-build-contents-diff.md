### Build Contents Diff RFC 

## Context
In order to make decisions about what to do with any given build generated by TBS, users need to compare a new build’s contents with the contents of other builds.

## Goals
Create a new command, `kp build diff`, for printing the difference between two builds. The command will take one required argument and two optional arguments.
 
Examples:
`kp build diff image-name`
Compares the two most recent builds
`kp build diff image-name build-number1`
Compares the stated build and the build minus 1
`kp build diff image-name build-number1 build-number2`
Compares the two specified builds
 
Three use cases that this feature should ideally satisfy:
 
- As a DevOps engineer, when I see a new build has been created in a lower environment, I want to evaluate what benefit it provides to my team for me to promote this build to an upper environment. 
 
- As a DevOps engineer or App Developer, when I am told there is a problem with a specific build (new build failing in CI or old build failing in production), I want to know what’s different about the problem build than the last one that worked. 

- As an App Developer, I want to see the difference between the commit I built locally with pack yesterday and the build that kpack built for me today based on my commit. 
 
Implications: 
- User will need to compare their most recent build to the older build in production
i.e. builds being compared are non-adjacent 
- Because the builds are non-adjacent, many things are likely to have changed in the contents and there will have been many “Reasons” that caused the intervening builds. Therefore, it doesn’t make a lot of sense to print the “Reason” as part of the diff
- I assume that it is easy / possible for users to access the build number associated with a container in production (perhaps there is another build identifier we could use?)



## Prior Art 
Differences from the reason diff RFC that’s been added to `kp build status`:
COMMIT is the same 
CONFIG is the same
BUILDPACK is different because it prints the Bill of Materials which represents the results of the buildpacks used instead of only the buildpack/s that caused the new build to kick off
STACK is the same now, but will be different once we have more stack metadata such as the dpackage list (and someday a CVE list) that we can print
 
Competitor examples: 
https://github.com/GoogleContainerTools/container-diff

## Complexity/Risks
- Would this be helpful for diagnosing failed builds or builds that don't start? If so, how can we surface this info without a BoM being generated? 
- How does all this show up in CI, if at all? 

## Alternatives
- Add information about build contents diff to the kp build status command
  - Pros:
Reduce the CLI surface area 
May be a more intuitive location
  - Cons:
Makes a command with long output even longer 
- Print / pipe out two YAML or JSON files that represent the build contents and allow the user to diff them with the tool of their choice 
  - Pros:
Export two image digests and compare them 
  - Cons: 
More work for the user

- Everything the same as the proposal, except show the things that didn’t change only with a verbose flag 
 
Deliver a feature like this as part of a separate tool:
- Registry  
- `Pack`


## Mockups 
Notes on WIP mockup
- don’t really love the all caps headers (maybe bold or other color?)
- should there be some kind of header info to set the stage for the diff? 
 
------------------
``` 
$kp build diff petclinic 37 13
COMMIT
- Revision: 234890hpe9vjsr8gse98rghser
+ Revision: 43t789wghges87h540eq8378ge
 
CONFIG
apiVersion: kpack.io/v1alpha1
kind: Build
metadata:
  name: sample-build
spec:
  tags:
  - sample/image
  serviceAccount: service-account
  builder:
    image: gcr.io/paketo-buildpacks/builder:base
    imagePullSecrets: 
    - name: builder-secret  
  cacheName: persisent-volume-claim-name
  source:
    git:
      url: https://github.com/buildpack/sample-java-app.git
      revision: master
  env:
  - name: "JAVA_BP_ENV"
    value: "value"
  resources:
    requests:
-     cpu: "0.25"
+     cpu: "0.5"
      memory: "128M"
    limits:
      cpu: "0.5"
      memory: "256M"
 
BUILDPACK
- buildpack:
    id: org.cloudfoundry.openjdk
    version: 1.0.0-RC03
  metadata:
    licenses:
    - type: GPL-2.0 WITH Classpath-exception-2.0
      uri: https://openjdk.java.net/legal/gplv2+ce.html
    name: OpenJDK JDK
    sha256: 90c33cf3f2ed0bd773f648815de7347e69cfbb3416ef3bf41616ab1c4aa0f5a8
    stacks:
    - io.buildpacks.stacks.bionic
    - org.cloudfoundry.stacks.cflinuxfs3
    uri: https://github.com/AdoptOpenJDK/openjdk11-binaries/releases/download/jdk-11.0.4%!B(MISSING)11/OpenJDK11U-jdk_x64_linux_hotspot_11.0.4_11.tar.gz
  name: openjdk-jdk
- version: 11.0.4
+ version: 11.0.5
 
STACK
- RunImage: index.docker.io/paketobuildpacks/run@sha256:34978twgsui4789et0wh9384erhsg0e798riuhgs0er7iugshe98riugeh99rgaser892
+ RunImage: index.docker.io/paketobuildpacks/run@sha256:fh34578tg29wb645rwhs87e5hrw0e98jtfnws9e7w378qe49tr3g39n5gwe9u5hge549w
```

## Appendix
There are five reasons a build will have been generated and each has a different fidelity of information that we can provide to our users: 

COMMIT
If the image in question is built with source code in a git repository, there will be a SHA associated with the commit which can be used to look up in Github/etc the commit that resulted in the build. 
This doesn’t provide any semantic value in and of itself, but it provides a pointer to semantic value 

CONFIG
We can print a diff of the two image config files (if anything has changed). This will show info about how environment variables, source code, and image settings are different between the two builds. Changes in environment variables may represent changes to the contents of the build because they may specify a dependency version to be used. 

STACK
Today we can only print old and new stack image URLs, nothing about what is actually in the stacks
This means that we can’t satisfy use case 1 for this variation, since nothing meaningful will show up in the diff itself and because it requires the user to do a pretty involved task: download the two stack images and extract their dpackage lists and then diff them, or manually read the release notes to infer the differences in the stacks that might benefit them
Since we hypothesize that stack updates are where most users will find initial and frequent value, the absence of meaningful stack information is a significant blocker to this feature delivering value.
I assume this limitation would have no bearing on use case 2 because ABI compatibility should ensure that a stack update is never the cause of a build error 
 
BUILDPACK
Today we have a couple options for showing buildpack differences: the buildpacks used list from `kp build status` and the Bill of Materials from the lifecycle. 
One restriction of the Bill of Materials is that only the Java Paketo buildpacks have rich and thoughtful metadata today. The Paketo team has not yet invested in BoM metadata for the other metabuildpacks for other languages. 
It’s unclear to me today to what extent the Bill of Materials really makes clear what dependencies have been installed in the container. I need some help to validate this 
The Bill of Materials is a JSON file. This could theoretically be converted into a nice tabular format, but since the data types associated with each buildpack object in the JSON are arbitrary, this would be hard to maintain / cover all use cases. Instead, I recommend we simply choose a JSON pretty print tool and use that layout. 

TRIGGER
This is not relevant to a build contents diff since it shouldn’t have any bearing on the contents of the build. 
 
 
 
 
 
